<!doctype html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>TOTP</title>
  <link rel="stylesheet" href="https://unpkg.com/@picocss/pico@latest/css/pico.min.css">
</head>
<body style="display:flex;flex-direction:column;justify-content:center;align-items:center;text-align:center;height:100dvh;margin:0;">
  <main style="width:320px;">
    <h2 style="text-align:center;margin-bottom:15px;">TOTP Generator</h2>

    <fieldset style="margin:5px 0;text-align:left;">
      <legend>Secret Key</legend>
      <input id="secret" type="password" placeholder="e.g. JBSWY3DPEHPK3PXP" autocomplete="off"
        style="font-family:monospace;width:100%;font-size:18px;padding:6px;">
      <label style="display:flex;align-items:center;font-size: 0.85rem;" for="show-secret">
        <input id="show-secret" type="checkbox" role="switch">
        Show secret key
      </label>
    </fieldset>

    <fieldset style="margin:5px 0;text-align:left;">
      <legend>Code</legend>
      <input id="code" readonly
        style="font-family:monospace;font-weight:bold;letter-spacing:2px;text-align:center;cursor:pointer;font-size:32px;padding:10px;">
      <small id="valid-helper" hidden>Copied!</small>
      <div id="timer" style="text-align:center;color:#aaa;font-size:16px;">Next refresh in 30s</div>
    </fieldset>

    <footer class="container" style="padding:0.5rem;text-align:center;font-size:0.9rem;">
      <p>
        <small>
          Made by <a href="https://github.com/mmosiek" class="secondary" target="_blank">mmosiek</a>, Source on <a href="https://github.com/mmosiek/totp" class="secondary" target="_blank">GitHub</a>.
        </small>
      </p>
    </footer>
  </main>

  <script>
    const base32 = s => {
      if (!s) return new Uint8Array();
      const a = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ234567';
      s = s.toUpperCase().replace(/[^A-Z2-7]/g, '');
      let bits = 0, v = 0, out = [];
      for (const c of s) {
        v = (v << 5) | a.indexOf(c);
        bits += 5;
        if (bits >= 8) {
          bits -= 8;
          out.push((v >> bits) & 255);
        }
      }
      return new Uint8Array(out);
    };

    async function hotp(secret, c) {
      const key = await crypto.subtle.importKey('raw', secret, { name: 'HMAC', hash: 'SHA-1' }, false, ['sign']);
      const buf = new ArrayBuffer(8), view = new DataView(buf);
      for (let i = 7; i >= 0; i--) {
        view.setUint8(i, Number(c & 255n));
        c >>= 8n;
      }
      const sig = new Uint8Array(await crypto.subtle.sign('HMAC', key, buf));
      const o = sig.at(-1) & 15;
      const n = ((sig[o] & 127) << 24) | (sig[o + 1] << 16) | (sig[o + 2] << 8) | sig[o + 3];
      return String(n % 1e6).padStart(6, '0');
    }

    const sEl = document.getElementById('secret'),
          showEl = document.getElementById('show-secret'),
          cEl = document.getElementById('code'),
          tEl = document.getElementById('timer'),
          validHelper = document.getElementById('valid-helper');

    showEl.onchange = () => {
      sEl.type = showEl.checked ? 'text' : 'password';
    };

    let last, progressEl;

    async function upd() {
      const now = Date.now();
      const ctr = BigInt(Math.floor(now / 3e4));
      const remain = 30 - Math.floor((now / 1e3) % 30);
      const percent = Math.floor((remain / 30) * 100);
      tEl.textContent = `Next refresh in ${remain}s`;

      if (!progressEl) {
        progressEl = document.createElement("progress");
        progressEl.max = 100;
        progressEl.style.width = "100%";
        tEl.insertAdjacentElement("afterend", progressEl);
      }
      progressEl.value = percent;

      if (percent <= 0) {
        progressEl.remove();
        progressEl = null;
      }

      let s = sEl.value.trim();
      if (!s) s = 'JBSWY3DPEHPK3PXP';
      const bytes = base32(s);

      if (ctr !== last) {
        cEl.value = await hotp(bytes, ctr);
        last = ctr;
      }
    }

    setInterval(upd, 1000);
    upd();

    cEl.onclick = () => {
      navigator.clipboard.writeText(cEl.value).catch(() => {});
      cEl.setAttribute('aria-describedby', 'valid-helper');
      validHelper.hidden = false;
      setTimeout(() => {
        cEl.removeAttribute('aria-describedby');
        validHelper.hidden = true;
      }, 1000);
    };

    sEl.oninput = () => { last = null; upd(); };
    sEl.onfocus = () => sEl.select();
    cEl.onfocus = () => cEl.select();
  </script>
</body>
</html>
